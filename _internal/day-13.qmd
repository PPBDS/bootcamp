---
title: "Day 13"
execute: 
  echo: false
---


### Notes

Make sure students have their data, their outcome variable and their covariates. Practice presentations of the final projects are just a week away. 

*Problem*: Use `nhanes` tibble from **primer.data** to answer this question: What is the difference in pulse rate between two randomly selected female students in this class? 

### Wisdom

The model is predictive, not causal.
The units are women.
The outcome is pulse.
There is no covariate, although we could have gender as a covariate, if we did not filter our men.
There is no treatment variable.
Describe the Preceptor Table.
Explore the data.

Does validity hold? Can we "stack" the Preceptor Table and the data to make a Population Table?


```{r}
#| message: false
library(tidyverse)
library(primer.data)
library(rstanarm)
```

```{r}
x <- nhanes |> 
  select(pulse, gender) |> 
  drop_na() |> 
  filter(gender == "Female")
```


```{r}
x |> 
  ggplot(aes(x = pulse)) +
    geom_histogram(bins = 200) 
```

## Justice

Describe the Population Table.

One reason why stability does not hold.
One reason why representativeness does not hold.
Don't need to worry about unconfoundedness since we have a predictive, not causal model.

Mathematical formula is just linear, pulse ~ 1

## Courage

Fit the model


```{r}
fit_obj <- stan_glm(data = x, 
                    formula = pulse ~ 1, 
                    family = gaussian, 
                    refresh = 0,
                    seed = 9)
```

```{r}
fit_obj
```
```{r}
print(fit_obj, detail = FALSE)
```

## Temperance

Time to answer the question: What is the difference in pulse rate between two randomly selected female students in this class? 

What new observations do we need to simulate? Two women and their pulse rates.


```{r}
newobs <- tibble(.rows = 2)
```


```{r}
results <- posterior_predict(object = fit_obj,
                        newdata = newobs) |> 
  as_tibble() |> 
  mutate(diff = abs(`1` - `2`)) 
```

```{r}
results |> 
  ggplot(aes(x = diff)) +
    geom_histogram(aes(y = after_stat(count/sum(count))),
                   bins = 100) +
    labs(title = "Posterior for Pulse Difference Between Two Women",
         subtitle = "The expected value for this difference would be much more narrow",
         x = "Absolute Value of Pulse Difference",
         y = "Probability",
         caption = "Data source: NHANES") + 
    scale_x_continuous(breaks = seq(0, 50, 10),
                       labels = scales::number_format()) +
    scale_y_continuous(labels = scales::percent_format()) 
```



